# ü§ñ SonarQube Code Smell Auto-Fix System

> üá®üá≥ ‰∏≠ÊñáÁâà: [README.md](./README.md) | üåç English: README_EN.md

<div align="center">

![Version](https://img.shields.io/badge/version-1.1.0-blue.svg)
![Python](https://img.shields.io/badge/python-3.8+-green.svg)
![License](https://img.shields.io/badge/license-MIT-yellow.svg)
![Status](https://img.shields.io/badge/status-active-success.svg)

</div>

## üìñ Overview

**An intelligent, automation-first code quality management system powered by LangGraph.**

Tired of endless SonarQube code smells piling up? Fed up with fixing repetitive low‚Äëvalue issues manually? This project exists to solve exactly that. üéâ

This system is **intelligent** and **fully automated**. It can:

- üîç Automatically scan unhandled code smells from SonarQube
- ü§ñ Generate AI-driven remediation suggestions (Kimi K2 model)
- üåø Orchestrate the full lifecycle: branch creation ‚Üí code modification ‚Üí PR creation
- üìä Track cumulative remediation effort for your team
- üí¨ Send smart notifications (Feishu group + direct messages)
- üéØ Precisely map responsibility via email ‚Üí GUID ‚Üí OpenID mappings

[Quick Start](#-quick-start) ‚Ä¢ [Key Features](#-key-features) ‚Ä¢ [Usage Guide](#-usage-guide) ‚Ä¢ [Configuration](#-configuration) ‚Ä¢ [Architecture](#-architecture)

---

## ‚ú® Key Features

### üé≠ Multi-Agent Collaboration

Seven specialized Agents work together‚Äîeach with a single responsibility:

| Agent | Role | Highlights |
|-------|------|-----------|
| üîç **IssueAnalyzerAgent** | Analyze code smells | Pagination, author filtering, intelligent dedupe |
| üõ†Ô∏è **WorkspaceSetupAgent** | Prepare workspace | Auto-create Git branches, environment prep |
| üí° **SolutionGeneratorAgent** | Propose fixes | AI-driven contextual remediation suggestions |
| ‚öôÔ∏è **FixExecutorAgent** | Apply changes | Precise file edits, syntax verification |
| üìù **PullRequestAgent** | Open PRs | Automated PR creation, reviewer assignment |
| üíæ **RecordKeeperAgent** | Persist records | Historical tracking, effort accumulation |
| üåê **BrowserLauncherAgent** | Open PR UI | Automatically launches PR page for review |

### üöÄ Powerful Workflow

- ‚úÖ **Paginated queries**: Handles large SonarQube datasets without memory spikes
- ‚úÖ **Author-based filtering**: Only process issues with identifiable owners
- ‚úÖ **Effort accounting**: Aggregates SonarQube effort estimates (minutes)
- ‚úÖ **Dual-channel notifications**: Feishu group + individual DMs
- ‚úÖ **Duplicate avoidance**: Historical record filtering
- ‚úÖ **Robust error handling**: Graceful fallbacks & retries
- ‚úÖ **Rich UI**: TUI built with `rich`

### üèóÔ∏è Tech Stack

- **üß† AI Engine**: Kimi K2 API (LLM-based suggestion generation)
- **üîÑ Workflow Engine**: LangGraph (state graph driven orchestration)
- **üîå Integration Layer**: MCP (Model Context Protocol)
  - SonarQube MCP Server
  - Azure DevOps MCP Server
- **üì± Notifications**: Feishu Webhook + Lark SDK
- **üêô VCS Automation**: GitPython

---

## üé¨ Quick Start

### üìã Prerequisites

- **Python** ‚â• 3.8
- **Git** installed and configured
- **Node.js** (for MCP servers; recommended ‚â• v16)
- Network access to SonarQube & Azure DevOps

### üì• Installation

#### 1Ô∏è‚É£ Clone the repository

```bash
git clone https://github.com/your-username/LangGraphSugAgent.git
cd LangGraphSugAgent
```

#### 2Ô∏è‚É£ Install dependencies

```bash
pip install -r requirements.txt
```

Included dependencies:

```text
langgraph==0.2.45       # Workflow engine
langchain==0.3.7        # LLM application framework
requests==2.32.3        # HTTP client
gitpython==3.1.43       # Git automation
rich==13.9.4            # Terminal UI
mcp==1.12.4             # MCP protocol support
lark-oapi==1.0.37       # Feishu SDK
```

> Note: `mcp` SDK enables Python-side MCP connections.

#### 3Ô∏è‚É£ Configure MCP servers

Edit `localJSON/mcp.json`:

```json
{
  "mcpServers": {
    "sonarqube": {
      "command": "npx",
      "args": ["--yes", "sonarqube-mcp-server@latest"],
      "env": {
        "SONARQUBE_URL": "YOUR_SONAR_URL",
        "SONARQUBE_USERNAME": "USERNAME",
        "SONARQUBE_PASSWORD": "PASSWORD"
      }
    },
    "azureDevOps": {
      "type": "stdio",
      "command": "cmd",
      "args": ["/c", "npx", "-y", "@tiberriver256/mcp-server-azure-devops"],
      "env": {
        "AZURE_DEVOPS_ORG_URL": "https://dev.azure.com/your-org",
        "AZURE_DEVOPS_AUTH_METHOD": "pat",
        "AZURE_DEVOPS_PAT": "YOUR_PAT",
        "AZURE_DEVOPS_DEFAULT_PROJECT": "YourProject"
      }
    }
  }
}
```

#### 4Ô∏è‚É£ Prepare data files

On first run they will be auto-created if missing:

- `codeSmallList.json` ‚Äî processed smell records (start with `[]`)
- `emailToGuid.json` ‚Äî email ‚Üí Azure DevOps GUID map
- `emialtoOpenId.json` ‚Äî email ‚Üí Feishu OpenID map
- `effort_state.json` ‚Äî effort accumulator (`{"total_Effort_time": 0}`)

#### 5Ô∏è‚É£ Adjust configuration

Edit `config.py` according to your environment (see below).

### üéÆ Run

#### Option A: Windows batch script

Double-click `start.bat`:

```text
====================================
 SonarQube Auto Fix System
====================================

Select an action:
1. Run system tests
2. Show system status
3. Start auto-fix
4. Reset processed records
5. Help
0. Exit
```

#### Option B: Direct Python

```bash
python main.py          # Run orchestrator
python cli.py status    # Show status
python cli.py test      # Run tests
python cli.py reset     # Reset record state
```

#### Option C: CLI dry run

```bash
python cli.py help
python cli.py run --dry-run
```

### ‚úÖ First Run Checklist

1. Run tests: `python cli.py test`
2. Check status: `python cli.py status`
3. Perform dry run: `python cli.py run --dry-run`
4. Launch full run: `python main.py`

---

## ‚öôÔ∏è Configuration

### üìÅ Core Paths (`config.py` excerpt)

```python
class Config:
    PROJECT_ROOT = os.path.dirname(os.path.abspath(__file__))
    MCP_CONFIG_PATH = os.path.join(PROJECT_ROOT, "localJSON", "mcp.json")
    CODE_SMELL_LIST_PATH = os.path.join(PROJECT_ROOT, "localJSON", "codeSmallList.json")
    EMAIL_TO_GUID_PATH = os.path.join(PROJECT_ROOT, "localJSON", "emailToGuid.json")
    EMAIL_TO_OPEN_ID_PATH = os.path.join(PROJECT_ROOT, "localJSON", "emialtoOpenId.json")
    TOTAL_EFFORT_STATE_PATH = os.path.join(PROJECT_ROOT, "localJSON", "effort_state.json")
```

All are absolute paths; customize only if relocating storage.

### üéØ SonarQube Settings

```python
class Config:
    SONARQUBE_PROJECT_KEY = "yourProject"
    SONARQUBE_BRANCH = "master"
    SONARQUBE_SEVERITIES = ["INFO"]
    SONARQUBE_TYPES = ["CODE_SMELL"]
```

| Field | Description | Allowed | Example |
|-------|-------------|---------|---------|
| `SONARQUBE_PROJECT_KEY` | Project key | Any string | `my-project` |
| `SONARQUBE_BRANCH` | Branch to analyze | Git branch | `master` |
| `SONARQUBE_SEVERITIES` | Severities to include | BLOCKER/CRITICAL/MAJOR/MINOR/INFO | `["INFO","MINOR"]` |
| `SONARQUBE_TYPES` | Issue types | CODE_SMELL/BUG/VULNERABILITY | `["CODE_SMELL"]` |

### üî∑ Azure DevOps

```python
class Config:
    AZURE_DEVOPS_PROJECT = "yourProject"
    AZURE_DEVOPS_REPOSITORY = "yourProject"
    AZURE_DEVOPS_TARGET_BRANCH = "refs/heads/master"
    AZURE_DEVOPS_TASK_ID = "283356"
    DEFAULT_REVIEWER = "87790f0c-0021-4777-886a-ff6f7622a77b"
```

| Field | Description | Format | Notes |
|-------|-------------|--------|-------|
| `AZURE_DEVOPS_PROJECT` | Project name | string | Appears in URL |
| `AZURE_DEVOPS_REPOSITORY` | Repo name | string | Must exist locally |
| `AZURE_DEVOPS_TARGET_BRANCH` | PR target ref | `refs/heads/<branch>` | Usually master/main |
| `AZURE_DEVOPS_TASK_ID` | Work item ID | numeric string | For traceability |
| `DEFAULT_REVIEWER` | Fallback reviewer GUID | GUID | Used if no author mapping |

### üí¨ Feishu (Lark) Notifications

```python
class Config:
    FEISHU_WEBHOOK_URL = "https://www.feishu.cn/flow/api/trigger-webhook/xxxxx"
    FEISHU_APP_ID = "cli_xxxxxxxxxxxxxxxxx"
    FEISHU_APP_SECRET = os.getenv("FEISHU_APP_SECRET", "<SET_ME>")
```

| Field | Purpose | Retrieval |
|-------|---------|-----------|
| `FEISHU_WEBHOOK_URL` | Group broadcast | Group settings ‚Üí Bot ‚Üí Webhook |
| `FEISHU_APP_ID` | App identifier | Feishu open platform |
| `FEISHU_APP_SECRET` | App secret | Keep secret‚Äîuse env var |

Use Webhook for group messages; App credentials for DMs.

### üåø Git Settings

```python
class Config:
    GIT_REPO_PATH = os.path.join(PROJECT_ROOT, "yourProject")
    GIT_BRANCH_NAME_TEMPLATE = "fix-sonar-{smell_key}"
    GIT_COMMIT_MESSAGE_TEMPLATE = "fix: Resolve SonarQube smell {smell_key} - {description}"
```

| Field | Role | Variables | Example |
|-------|------|-----------|---------|
| `GIT_BRANCH_NAME_TEMPLATE` | Branch naming | `{smell_key}` | `fix-sonar-AYzqY123` |
| `GIT_COMMIT_MESSAGE_TEMPLATE` | Commit message | `{smell_key}`, `{description}` | `fix: Resolve SonarQube smell AYz... - Remove unused var` |

### üìù Pull Request Templates

```python
class Config:
    PR_TITLE_TEMPLATE = "fix: Resolve SonarQube smell {smell_key}"
    PR_DESCRIPTION_TEMPLATE = """
## SonarQube Code Smell Fix

**Smell Key:** {smell_key}
**Description:** {description}
**File:** {file_path}

### Context
- Task ID: {task_id}
- Generated by Auto-Fix System

### Checklist
- [x] Patch applied
- [x] Syntax validated
- [ ] Manual review complete
"""
```

### üìä Effort Tracking

Each SonarQube issue has an `effort` (estimated minutes). The system sums these into `effort_state.json`:

```json
{ "total_Effort_time": 1250 }
```

Used in notifications to show cumulative impact.

---

## üìÑ Data File Details

### 1Ô∏è‚É£ `codeSmallList.json`

Tracks processed smells to avoid duplicate work.

```json
[
  {
    "key": "AYzqY1234567890",
    "rule": "csharpsquid:S1481",
    "severity": "INFO",
    "component": "yourProject:src/Controllers/UserController.cs",
    "line": 45,
    "message": "Remove this unused private field 'userName'.",
    "author": "john.doe@company.com",
    "creationDate": "2025-10-15T10:30:00+0800",
    "processedDate": "2025-10-15T14:20:00+0800",
    "status": "FIXED",
    "prUrl": "https://azure-devops.com/project/pullrequest/12345"
  }
]
```

### 2Ô∏è‚É£ `emailToGuid.json`

Email ‚Üí Azure DevOps GUID mapping for PR reviewers.

### 3Ô∏è‚É£ `emialtoOpenId.json`

Email ‚Üí Feishu OpenID for DM notifications.

### 4Ô∏è‚É£ `effort_state.json`

Cumulative minutes of resolved effort.

### 5Ô∏è‚É£ `mcp.json`

External MCP service definitions (SonarQube, Azure DevOps, etc.).

---

## üèóÔ∏è Architecture

### üîÑ Workflow

```text
SonarQube Scan
   ‚îÇ
   ‚ñº
IssueAnalyzerAgent (filter/paginate/dedupe)
   ‚îÇ
   ‚ñº
WorkspaceSetupAgent (branch/env)
   ‚îÇ
   ‚ñº
SolutionGeneratorAgent (AI proposal)
   ‚îÇ
   ‚ñº
FixExecutorAgent (apply + commit + push)
   ‚îÇ
   ‚ñº
PullRequestAgent (PR + notifications)
   ‚îÇ
   ‚ñº
RecordKeeperAgent (persist + effort)
   ‚îÇ
   ‚ñº
BrowserLauncherAgent (open PR UI)
```

### üß© Logical Layout

```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      SonarQubeAutoFixOrchestrator      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ                     ‚îÇ
 LangGraph StateGraph   MCP Clients
     ‚îÇ                     ‚îÇ
  7 Agents          SonarQube / Azure DevOps
     ‚îÇ                     ‚îÇ
  Utils Layer: Git / File / LLM / Notification
```

---

## üìö Usage Guide

### üêõ Common Issues

**MCP connection failed**:
1. Verify `mcp.json`
2. Check service reachability
3. Validate credentials / PAT permissions
4. View server logs

**No unprocessed smells**:
- All done already
- Filters too restrictive
- Missing author

Reset tracking:

```bash
python cli.py reset
```

**Git errors**:
- Not a repository ‚Üí Check `GIT_REPO_PATH`
- Permission denied ‚Üí Fix credentials
- Merge conflict ‚Üí Resolve manually then retry

**PR creation failed**:
- PAT scope insufficient
- Target branch missing
- Reviewer GUID invalid

**Feishu notification failed**:
- Webhook revoked
- App credentials invalid
- OpenID mapping incomplete

### üí° Best Practices

Incremental rollout:

```text
Day 1: INFO
Day 2: MINOR
Day 3: MAJOR & above
```

Backups:

```bash
copy localJSON\codeSmallList.json localJSON\codeSmallList.backup.json
copy localJSON\effort_state.json localJSON\effort_state.backup.json
```

Review cadence:
- Periodically audit generated PRs
- Monitor Feishu delivery
- Analyze cumulative effort metrics

---

## üéì Resources

- **LangGraph**: https://langchain-ai.github.io/langgraph/
- **MCP Protocol**: https://modelcontextprotocol.io/
- **SonarQube Web API**: https://docs.sonarqube.org/latest/extend/web-api/
- **Azure DevOps REST**: https://learn.microsoft.com/en-us/rest/api/azure/devops/
- **Feishu Platform**: https://open.feishu.cn/document/

---

## ü§ù Contributing

We welcome contributions! ‚ú®

**How to contribute**:
1. Open an Issue (bug/feature)
2. Fork & branch: `git checkout -b feature/amazing-feature`
3. Commit: `git commit -m "‚ú® Add amazing feature"`
4. Push & open PR

**Standards**:
- PEP 8 style
- Chinese or bilingual docstrings (if aligning with existing codebase)
- Type hints encouraged
- Include unit tests

---

## üìú License

Released under the **MIT License**. You are free to use, modify, distribute, and private-host.

---

## üôè Acknowledgements

- LangChain & LangGraph
- Kimi K2 Model
- MCP Protocol
- SonarQube
- Azure DevOps
- Feishu
- Rich

---

## üìÆ Contact

- **GitHub Issues**: https://github.com/your-username/LangGraphSugAgent/issues
- **Email**: your-email@example.com

---

## ‚≠ê Star History

If this project helps you, please give it a ‚≠ê‚Äîyour support keeps it evolving! üí™

---

<div align="center">
Made with ‚ù§Ô∏è by Your Name / Team  
Current Version: v1.1.0 | Last Updated: 2025-10-15  

‚¨Ü Back to Top
</div>
